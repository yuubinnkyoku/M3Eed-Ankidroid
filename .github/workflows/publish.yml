name: ðŸš€ Publish

on:
  workflow_dispatch:
    inputs:
      public:
        description: "any non-empty value triggers a public build - version not auto-incremented / changelog required"
        required: false
        type: string

# We want concurrency control to allow multiple runs, but serially
# Otherwise if you run two publishes that upload to google at same time
# (for instance on a release branch for beta, and main for alpha), google
# will error as it can only handle one edit in publish account at once
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  release_app:
    name: "Release App"
    timeout-minutes: 120
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/cache@v4
        name: Gradle Cache
        with:
          path: ~/.gradle/caches
          key: gradle-${{ hashFiles('**/*.gradle*') }}-v1

      - name: Configure JDK
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Install Release Utilities
        run: |
          sudo chown -R $USER /var/lib/gems/
          sudo chown -R $USER /usr/local/bin
          gem install asciidoctor
        shell: bash

      - name: GIT Setup
        run: |
          git config --global user.name 'Mike Hardy'
          git config --global user.email 'github@mikehardy.net'
          git remote set-url origin git@github.com:$GITHUB_REPOSITORY
        shell: bash

      - uses: webfactory/ssh-agent@v0.9.1
        if: "${{ github.event.inputs.public != '' }}" # publicãƒªãƒªãƒ¼ã‚¹ã®å ´åˆã®ã¿SSHã‚­ãƒ¼ã‚’ä½¿ç”¨
        with:
          ssh-private-key: DUMMY_SSH_PRIVATE_KEY # ãƒ€ãƒŸãƒ¼å€¤

      - name: Credential Prep
        if: "${{ github.event.inputs.public != '' }}" # publicãƒªãƒªãƒ¼ã‚¹ã®å ´åˆã®ã¿èªè¨¼æƒ…å ±ã‚’æº–å‚™
        run: |
          echo "KEYSTOREPATH=$HOME/src/android-keystore" >> $GITHUB_ENV
          echo "KEYALIAS=nrkeystorealias" >> $GITHUB_ENV
          echo "KEYSTOREPWD=DUMMY_KEYSTORE_PASSWORD" >> $GITHUB_ENV # ãƒ€ãƒŸãƒ¼å€¤
          echo "KEYPWD=DUMMY_KEYSTORE_KEY_PASSWORD" >> $GITHUB_ENV # ãƒ€ãƒŸãƒ¼å€¤
          mkdir ~/src
          cd ~/src
          echo "DUMMY_AMAZON_PUBLISH_CREDENTIALS" | base64 -d > ./AnkiDroid-Amazon-Publish-Security-Profile.json.gz # ãƒ€ãƒŸãƒ¼å€¤
          echo "DUMMY_GOOGLE_PUBLISH_CREDENTIALS" | base64 -d > ./AnkiDroid-GCP-Publish-Credentials.json.gz # ãƒ€ãƒŸãƒ¼å€¤
          echo "DUMMY_RELEASES_PUBLISH_TOKEN" | base64 -d > ./my-github-personal-access-token.gz # ãƒ€ãƒŸãƒ¼å€¤
          echo "DUMMY_KEYSTORE" | base64 -d > ./android-keystore.gz # ãƒ€ãƒŸãƒ¼å€¤
          gunzip *.gz
        shell: bash

      - name: Build and Release public release
        if: "${{ github.event.inputs.public != '' }}"
        run: |
          pushd ../
          git clone git@github.com:ankidroid/ankidroiddocs
          popd
          ./tools/release.sh public
        shell: bash

      - name: Build and Release test release
        if: "${{ github.event.inputs.public == '' }}"
        run: ./tools/release.sh
